---
title: "Аналитический отчет"
output: html_document
date: "2023-12-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Введение

Для анализа были взяты предварительно обработанные данные из трех источников: СберИндекс, ДомКлик и Росстат, представленные в открытом доступе и отображающие распределение социоэкономических показателей по регионам России. Итоговый объединенный датафрейм, взятый для анализа, включает 15 показателей (Итоговая таблица.xslx):

* Регион
* Месяц
* Квартал
* Индекс потребительской активности
* Доля безналичных платежей
* Количество внутренних туристов
* Общее количество одобренных заявок на кредит
* Доля онлайн-заявок на кредит
* Доля заявок на кредит в офисе банка
* Общее количество ипотечных сделок
* Доля сделок, первичное жилье
* Доля сделок, вторичное жилье
* Среднемесячная заработная плата
* Число активных абонентов беспроводного интернета
* Уровень безработицы населения

**Задачи исследования:**

* Проанализировать особенности распределения указанных выше показателей
* Выбрать среди регионов России наиболее перспективные для открытия филиалов *TrustUs*
* Выявить ключевые факторы, определяющие спрос населения на банковски услуги

На основании сравнительного анализ социально-экономических показателей выбрать наиболее перспективные регионы для открытия филиалов банка

# Разведывательный анализ:

```{r, message=FALSE}
# Подгружаем библиотеки:
library(tidyverse)
library(readxl)
library(psych)
```

```{r, warning=FALSE}
# Загружаем данные:
dat <- read_xlsx("Итоговая таблица.xlsx")
dat$`Число активных абонентов беспроводного доступа к сети` <- as.numeric(dat$`Число активных абонентов беспроводного доступа к сети`)
dat$Месяц <- factor(dat$Месяц, ordered = TRUE,
                        levels = c("Январь", "Февраль", "Март", 
                                                "Апрель", "Май", "Июнь", "Июль",
                                                "Август", "Сентябрь", "Октябрь",
                                                "Ноябрь", "Декабрь"))
dat$Квартал <- factor(dat$Квартал,
                         levels = c("Квартал 1", "Квартал 2", "Квартал 3", "Квартал 4"))

dat$`Всего одобренных заявок` <- factor(dat$`Всего одобренных заявок`,
                                               ordered = TRUE,
                                               levels = c("100 - 500",
                                                          "500 - 1 000",
                                                          "1 000 - 5 000",
                                                          "5 000 - 10 000",
                                                          "> 10 000"))
dat$`Всего ипотечных сделок` <- factor(dat$`Всего ипотечных сделок`,
                                          ordered = TRUE,
                                          levels = c("10 - 50",
                                                     "50 - 100",
                                                     "100 - 500",
                                                     "500 - 1 000",
                                                     "> 1 000"))

```


```{r}
# Выведем описательные статистики для показателей СберИндекс:
dat %>% 
  select(`Индекс потребительской активности` : `Количество внутренних туристов`) %>% 
  describe()

```

Можно отметить, что три исследуемых показателя (Индекс потребительской активности, доля безналичных платежей, количество внутренних туристов) имеют высокий размах, т.е. значительную разницу между минимальными и максимальными значениями показателей. Вместе с этим, имеются небольшие различия между медианными и средними значениями, что может говорить о наличии нетипичных значений. Значения skew во всех стрех случаях < 0, что говорит о скошенности распределения влево. 

Интересно отметить отрицательные значения медианы и среднего количества внутренних туристов, что может быть связано с противоэпидемическим режимом в 2020 г. И действительно, если посмотреть данные, отрицательные значения по большинству регионов появляются в апреле 2020 г, когда в полной мере были развернуты антиковидные ограничения.
```{r, warning=FALSE, message=FALSE}
## Построим график, отображающий динамику средних значений данных показателей по месяцам :
dat_mean <- dat %>%
  drop_na %>% 
  group_by(Месяц) %>% 
  summarise(`Индекс потребительской активности` = mean(`Индекс потребительской активности`),
            `Доля безналичных платежей` = mean(`Доля безналичных платежей`),
            `Количество внутренних туристов` = mean(`Количество внутренних туристов`))
dat_mean <- pivot_longer(data = dat_mean, cols = 2:4, names_to = "Индекс", values_to = "Значение")

dat_mean %>% 
  ggplot(aes(x = Месяц, y = Значение, group = Индекс, color = Индекс)) +
  geom_line(size = 0.8) +
  geom_point(size = 1.2) +
  labs(title = "Динамика средних показателей СберИндекс в 2020 году",
       x = "Месяц",
       y = "Среднее значение по России") +
  scale_colour_manual(values = c("tomato", "steelblue", "palegreen3")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey98"))
```

Графики динамики также отражают падение индекса потребительской активности и количества внутренних туристов весной 2020 г. При этом не уменьшилась доля безналичных платежей, что тоже кажется логичным. 

```{r}
dat_long <- dat %>%
  drop_na %>% 
  select(1:6) %>% 
  pivot_longer(cols = 4:6,names_to = "Индекс", values_to = "Значение")

dat_long %>% 
  ggplot(aes(y = Значение, group = Индекс, fill = Индекс)) +
  geom_boxplot(color = "gray30",
               outlier.fill = "coral",
               outlier.shape = 21,
               outlier.size = 1.8) +
  scale_fill_manual(values = c("lavender", "lightpink", "steelblue")) +
  facet_wrap(facets = ~Месяц) +
  scale_y_continuous(breaks = c(-50, -25, 0, 25, 50, 75)) +
  coord_cartesian(ylim = c(-80, 85)) +
  labs(title = "Разброс значений показателей СберИндекс по месяцам") +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = "grey99"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey97"),
        strip.background = element_rect(color = "grey70", fill = "grey95"))
  
```

Графики с усами также позволяют отследить динамику по месяцам для выбранных показателей, а таккже отображают большое количество нетипичных значений, которые следует изучить подробнее.

```{r, message=FALSE}
# Поиск нетипичных значений:
dat_clean <- dat %>% 
  drop_na()

get_outliers <- function(x){
  iqr <- IQR(x)
  q1 <- quantile(x, 0.25)
  q3 <- quantile(x, 0.75)
  lower_b <- q1 - 1.5 * iqr
  upper_b <- q3 + 1.5 * iqr
  extra <- x[x < lower_b | x > upper_b]
  return(extra)
}

consume_out <- dat[dat$`Индекс потребительской активности` %in% get_outliers(dat_clean$`Индекс потребительской активности`), 1:4]
cashless_out <- dat[dat$`Доля безналичных платежей` %in% get_outliers(dat_clean$`Доля безналичных платежей`), c(1:3, 5)]
voyage_out <- dat[dat$`Количество внутренних туристов` %in% get_outliers(dat_clean$`Количество внутренних туристов`), c(1:3, 6)]

dat_out <- full_join(consume_out, cashless_out)
dat_out <- full_join(dat_out, voyage_out)

dat_out <- dat_out %>% 
  pivot_longer(cols = `Индекс потребительской активности` : `Количество внутренних туристов`, names_to = "Индекс", values_to = "Значение")
dat_out <- dat_out %>% 
  drop_na()
```

Рассмотрим, каким месяцам соотвествует наибольшее количество нетипичных значений:

```{r}
# Визуализируем нетипичные значения:
dat_out %>% 
  ggplot(aes(x = Месяц, fill = Индекс)) +
  geom_bar(color = "grey20") +
  labs(title = "Распределение выбросов по месяцам",
       x = "Месяц",
       y = "Количество") +
  scale_fill_manual(values = c("wheat", "lightpink2", "slategray3")) +
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "grey99"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey97"))
```

Нетипичные значения в показателе "Доля безналичных платежей" равномерно распределены и встречаются в каждом месяце. Соответственно, это сможет быть связано не периодом, а с определенными регионами.  Нетипичные значения количества внтутренних туристов встречаются в феврале, марте, августе и октябре. Вероятно. внутренний туризм в период с апреля по август был затруднен вследствие ограничений. Выбросы в показателе "Индекс потребительской активности " встречаются в четырех месяцах и с максимумом в апреле, что тоже укладывается в предположение о влиянии ограничений, связанных с пандемией COVID-19.
```{r}
# По регионам:
dat_out %>% 
  ggplot(aes(x = Регион, fill = Индекс)) +
  geom_bar(color = "grey20") +
  labs(title = "Распределение выбросов по регионам",
       x = "Регион",
       y = "Количество") +
  scale_fill_manual(values = c("wheat", "lightpink2", "slategray3")) +
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "grey99"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey97"))
```

Если посмотреть на распределение нетипичных значений по регионам, можно заметить, что выбросы среди значений индекса потребительской активности распределены равномерно, за исключением трех регионов. Так как нетипичные значения в апреле по этому показателю ниже граничного значения (q1 - 1.5 * IQR), то ,   вероятно, потребительская активность в этих регионах пострадала наиболее сильно. Нетипичные значения доли безналичных платежей соответствуют четырем регионам: Кабардино-Балкарской Республике, Республике Дагестан, республике Карачаево-Черкессии, Республике Северной Осетии-Алании. Так как нетипично низкие значения этого показателя распределены равномерно по месяцам, можно предположить, что в этих регионах более распространены платежи наличными.

```{r}
# Находим топ-30 регионов по индексу потребительской активности:
top_consume <- dat %>%
  drop_na %>% 
  group_by(Регион) %>% 
  summarise(mean_consume = mean(`Индекс потребительской активности`)) %>%
  arrange(desc(mean_consume)) %>%
  slice_head(n = 30)
```

```{r}
# Находим топ-30 регионов по доле безналичных платежей:
top_cashless <- dat %>%
  drop_na %>% 
  group_by(Регион) %>% 
  summarise(mean_cashless = mean(`Доля безналичных платежей`)) %>%
  arrange(desc(mean_cashless)) %>%
  slice_head(n = 30)
```

```{r}
# Находим регионы, общие для обоих датафреймов:
top_both <- inner_join(top_consume, top_cashless, by = "Регион")
top_both
```
```{r}
# Выберем в основном датафрейме только регионы, попавшие в топ:
top_both <- dat[dat$Регион %in% top_both$Регион, ]
```

```{r}
# Среди полученных регионов оставим только те, в которых индекс внутреннего туризма принимал значения выше 0 не менее чем в течение 5 месяцев:
top_both <- top_both %>% 
  mutate(tourindex = ifelse(`Количество внутренних туристов` > 0, 1, 0), .after = `Количество внутренних туристов`)

top_tour <- top_both %>% 
  group_by(Регион) %>% 
  summarise(tour_sum = sum(tourindex)) %>% 
  filter(tour_sum >= 5)
```

Выберем регионы, лидирующие по всем трем показателям:

```{r}
# Выберем из основного датафрейма регионы, лидирующие по всем трем показателями:
top <- dat[dat$Регион %in% top_tour$Регион, ]
unique(top$Регион)
```

Рассмотрим, в какие месяцы наблюдаются максимальные значения исследуемых нами показателей:

```{r, warning=FALSE, message=FALSE}
## Построим график, отображающий динамику значений исследуемых показателей по месяцам :
top_long <- top %>%
  select(1:6)

top_long <- pivot_longer(data = top_long, cols = 4:6, names_to = "Индекс", values_to = "Значение")

top_long %>% 
  ggplot(aes(x = Месяц, y = Значение, group = Индекс, color = Индекс)) +
  geom_line(size = 0.8) +
  geom_point(size = 1.2) +
  labs(title = "Динамика показателей СберИндекс наиболее перспективных регионов \n в 2020 году",
       x = "Месяц",
       y = "Значение") +
  scale_colour_manual(values = c("tomato", "steelblue", "palegreen3")) +
  facet_wrap(facets = ~`Регион`) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey98"))
```

Таким образом, наиболее наиболее перспективными для открытия филиалов банка являются следющие регионы (для каждого региона указан период, в котором наблюдались максимальные значения исследуемых показателей):

* Воронежская область
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: сентябрь
  + Количество внутренних туристов: январь - март, август - сентябрь
* Калининградская область
  + Доля безналичных платежей: май, ноябрь
  + Индекс потребительской активности: июнь - октябрь
  + Количество внутренних туристов: январь - февраль, июль - октябрь
* Камчатский край
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: февраль, июль - октябрь
  + Количество внутренних туристов: март, август - сентябрь, декабрь
* Кировская область
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: февраль, июнь - октябрь
  + Количество внутренних туристов: январь - март, август - сентябрь
* Нижегородская область
  + Доля безналичных платежей: май, ноябрь
  + Индекс потребительской активности: март, июль - октябрь
  + Количество внутренних туристов: январь - февраль, август - сентябрь
* Самарская область
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: март, июнь - ноябрь
  + Количество внутренних туристов: январь - март, август
  

```{r}
top %>% 
  group_by(Месяц) %>% 
  summarise(`Индекс потребительской активности` = mean(`Индекс потребительской активности`),
            `Доля безналичных платежей` = mean(`Доля безналичных платежей`),
            `Количество внутренних туристов` = mean(`Количество внутренних туристов`)) %>%
  pivot_longer(cols = 2:4, names_to = "Индекс", values_to = "Значение") %>% 
  ggplot(aes(x = Месяц, y = Значение, group = Индекс, color = Индекс)) +
  geom_line(size = 0.8) +
  geom_point(size = 1.2) +
  labs(title = "Динамика средних значений показателей СберИндекс \n выбранных регионов в 2020 году",
       x = "Месяц",
       y = "Значение") +
  scale_colour_manual(values = c("tomato", "steelblue", "palegreen3")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey98"))
```

Обобщая для всех регионов, месяцы, в которых показатели были максимальными:

* Доля безналичных платежей: май, ноябрь
* Индекс потребительской активности: февраль - март, июнь - октябрь
* Количество внутренних туристов: январь - март, сентябрь - октябрь
