---
title: "Аналитический отчет"
output: html_document
date: "2023-12-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Введение

Для анализа были взяты предварительно обработанные данные из трех источников: СберИндекс, ДомКлик и Росстат, представленные в открытом доступе и отображающие распределение социоэкономических показателей по регионам России. Итоговый объединенный датафрейм, взятый для анализа, включает 15 показателей (Итоговая таблица.xslx):

* Регион
* Месяц
* Квартал
* Индекс потребительской активности
* Доля безналичных платежей
* Количество внутренних туристов
* Общее количество одобренных заявок на кредит
* Доля онлайн-заявок на кредит
* Доля заявок на кредит в офисе банка
* Общее количество ипотечных сделок
* Доля сделок, первичное жилье
* Доля сделок, вторичное жилье
* Среднемесячная заработная плата
* Число активных абонентов беспроводного интернета
* Уровень безработицы населения

**Задачи исследования:**

* Проанализировать особенности распределения указанных выше показателей
* Выбрать среди регионов России наиболее перспективные для открытия филиалов *TrustUs*
* Выявить ключевые факторы, определяющие спрос населения на банковски услуги

На основании сравнительного анализ социально-экономических показателей выбрать наиболее перспективные регионы для открытия филиалов банка

# Разведывательный анализ:

```{r, message=FALSE}
# Подгружаем библиотеки:
library(tidyverse)
library(readxl)
library(psych)
#library(lmtest)
#library(sandwich)
library(pROC)
```

```{r, warning=FALSE}
# Загружаем данные:
dat <- read_xlsx("Итоговая таблица.xlsx")
dat$`Число активных абонентов беспроводного доступа к сети` <- as.numeric(dat$`Число активных абонентов беспроводного доступа к сети`)
dat$Месяц <- factor(dat$Месяц, ordered = TRUE,
                        levels = c("Январь", "Февраль", "Март", 
                                                "Апрель", "Май", "Июнь", "Июль",
                                                "Август", "Сентябрь", "Октябрь",
                                                "Ноябрь", "Декабрь"))
dat$Квартал <- factor(dat$Квартал,
                         levels = c("Квартал 1", "Квартал 2", "Квартал 3", "Квартал 4"))

dat$`Всего одобренных заявок` <- factor(dat$`Всего одобренных заявок`,
                                               ordered = TRUE,
                                               levels = c("100 - 500",
                                                          "500 - 1 000",
                                                          "1 000 - 5 000",
                                                          "5 000 - 10 000",
                                                          "> 10 000"))
dat$`Всего ипотечных сделок` <- factor(dat$`Всего ипотечных сделок`,
                                          ordered = TRUE,
                                          levels = c("10 - 50",
                                                     "50 - 100",
                                                     "100 - 500",
                                                     "500 - 1 000",
                                                     "> 1 000"))

```


```{r}
# Выведем описательные статистики для показателей СберИндекс:
dat %>% 
  select(`Индекс потребительской активности` : `Количество внутренних туристов`) %>% 
  describe()

```

Можно отметить, что три исследуемых показателя (Индекс потребительской активности, доля безналичных платежей, количество внутренних туристов) имеют высокий размах, т.е. значительную разницу между минимальными и максимальными значениями показателей. Вместе с этим, имеются небольшие различия между медианными и средними значениями, что может говорить о наличии нетипичных значений. Значения skew во всех стрех случаях < 0, что говорит о скошенности распределения влево. 

Интересно отметить отрицательные значения медианы и среднего количества внутренних туристов, что может быть связано с противоэпидемическим режимом в 2020 г. И действительно, если посмотреть данные, отрицательные значения по большинству регионов появляются в апреле 2020 г, когда в полной мере были развернуты антиковидные ограничения.
```{r, warning=FALSE, message=FALSE}
## Построим график, отображающий динамику средних значений данных показателей по месяцам :
dat_mean <- dat %>%
  drop_na %>% 
  group_by(Месяц) %>% 
  summarise(`Индекс потребительской активности` = mean(`Индекс потребительской активности`),
            `Доля безналичных платежей` = mean(`Доля безналичных платежей`),
            `Количество внутренних туристов` = mean(`Количество внутренних туристов`))
dat_mean <- pivot_longer(data = dat_mean, cols = 2:4, names_to = "Индекс", values_to = "Значение")

dat_mean %>% 
  ggplot(aes(x = Месяц, y = Значение, group = Индекс, color = Индекс)) +
  geom_line(size = 0.8) +
  geom_point(size = 1.2) +
  labs(title = "Динамика средних показателей СберИндекс в 2020 году",
       x = "Месяц",
       y = "Среднее значение по России") +
  scale_colour_manual(values = c("tomato", "steelblue", "palegreen3")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey98"))
```

Графики динамики также отражают падение индекса потребительской активности и количества внутренних туристов весной 2020 г. При этом не уменьшилась доля безналичных платежей, что тоже кажется логичным. 

```{r}
dat_long <- dat %>%
  drop_na %>% 
  select(1:6) %>% 
  pivot_longer(cols = 4:6,names_to = "Индекс", values_to = "Значение")

dat_long %>% 
  ggplot(aes(y = Значение, group = Индекс, fill = Индекс)) +
  geom_boxplot(color = "gray30",
               outlier.fill = "coral",
               outlier.shape = 21,
               outlier.size = 1.8) +
  scale_fill_manual(values = c("lavender", "lightpink", "steelblue")) +
  facet_wrap(facets = ~Месяц) +
  scale_y_continuous(breaks = c(-50, -25, 0, 25, 50, 75)) +
  coord_cartesian(ylim = c(-80, 85)) +
  labs(title = "Разброс значений показателей СберИндекс по месяцам") +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = "grey99"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey97"),
        strip.background = element_rect(color = "grey70", fill = "grey95"))
  
```

Графики с усами также позволяют отследить динамику по месяцам для выбранных показателей, а таккже отображают большое количество нетипичных значений, которые следует изучить подробнее.

```{r, message=FALSE}
# Поиск нетипичных значений:
dat_clean <- dat %>% 
  drop_na()

get_outliers <- function(x){
  iqr <- IQR(x)
  q1 <- quantile(x, 0.25)
  q3 <- quantile(x, 0.75)
  lower_b <- q1 - 1.5 * iqr
  upper_b <- q3 + 1.5 * iqr
  extra <- x[x < lower_b | x > upper_b]
  return(extra)
}

consume_out <- dat[dat$`Индекс потребительской активности` %in% get_outliers(dat_clean$`Индекс потребительской активности`), 1:4]
cashless_out <- dat[dat$`Доля безналичных платежей` %in% get_outliers(dat_clean$`Доля безналичных платежей`), c(1:3, 5)]
voyage_out <- dat[dat$`Количество внутренних туристов` %in% get_outliers(dat_clean$`Количество внутренних туристов`), c(1:3, 6)]

dat_out <- full_join(consume_out, cashless_out)
dat_out <- full_join(dat_out, voyage_out)

dat_out <- dat_out %>% 
  pivot_longer(cols = `Индекс потребительской активности` : `Количество внутренних туристов`, names_to = "Индекс", values_to = "Значение")
dat_out <- dat_out %>% 
  drop_na()
```

Рассмотрим, каким месяцам соотвествует наибольшее количество нетипичных значений:

```{r}
# Визуализируем нетипичные значения:
dat_out %>% 
  ggplot(aes(x = Месяц, fill = Индекс)) +
  geom_bar(color = "grey20") +
  labs(title = "Распределение выбросов по месяцам",
       x = "Месяц",
       y = "Количество") +
  scale_fill_manual(values = c("wheat", "lightpink2", "slategray3")) +
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "grey99"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey97"))
```

Нетипичные значения в показателе "Доля безналичных платежей" равномерно распределены и встречаются в каждом месяце. Соответственно, это сможет быть связано не периодом, а с определенными регионами.  Нетипичные значения количества внутренних туристов встречаются в феврале, марте, августе и октябре. Вероятно. внутренний туризм в период с апреля по август был затруднен вследствие ограничений. Выбросы в показателе "Индекс потребительской активности " встречаются в четырех месяцах и с максимумом в апреле, что тоже укладывается в предположение о влиянии ограничений, связанных с пандемией COVID-19.
```{r}
# По регионам:
dat_out %>% 
  ggplot(aes(x = Регион, fill = Индекс)) +
  geom_bar(color = "grey20") +
  labs(title = "Распределение выбросов по регионам",
       x = "Регион",
       y = "Количество") +
  scale_fill_manual(values = c("wheat", "lightpink2", "slategray3")) +
  theme(axis.text.x = element_text(angle = 90),
        panel.background = element_rect(fill = "grey99"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey97"))
```

Если посмотреть на распределение нетипичных значений по регионам, можно заметить, что выбросы среди значений индекса потребительской активности распределены равномерно, за исключением трех регионов. Так как нетипичные значения в апреле по этому показателю ниже граничного значения (q1 - 1.5 * IQR), то ,   вероятно, потребительская активность в этих регионах пострадала наиболее сильно. Нетипичные значения доли безналичных платежей соответствуют четырем регионам: Кабардино-Балкарской Республике, Республике Дагестан, республике Карачаево-Черкессии, Республике Северной Осетии-Алании. Так как нетипично низкие значения этого показателя распределены равномерно по месяцам, можно предположить, что в этих регионах более распространены платежи наличными.

```{r}
# Находим топ-30 регионов по индексу потребительской активности:
top_consume <- dat %>%
  drop_na %>% 
  group_by(Регион) %>% 
  summarise(mean_consume = mean(`Индекс потребительской активности`)) %>%
  arrange(desc(mean_consume)) %>%
  slice_head(n = 30)
```

```{r}
# Находим топ-30 регионов по доле безналичных платежей:
top_cashless <- dat %>%
  drop_na %>% 
  group_by(Регион) %>% 
  summarise(mean_cashless = mean(`Доля безналичных платежей`)) %>%
  arrange(desc(mean_cashless)) %>%
  slice_head(n = 30)
```

```{r}
# Находим регионы, общие для обоих датафреймов:
top_both <- inner_join(top_consume, top_cashless, by = "Регион")
top_both
```
```{r}
# Выберем в основном датафрейме только регионы, попавшие в топ:
top_both <- dat[dat$Регион %in% top_both$Регион, ]
```

```{r}
# Среди полученных регионов оставим только те, в которых индекс внутреннего туризма принимал значения выше 0 не менее чем в течение 5 месяцев:
top_both <- top_both %>% 
  mutate(tourindex = ifelse(`Количество внутренних туристов` > 0, 1, 0), .after = `Количество внутренних туристов`)

top_tour <- top_both %>% 
  group_by(Регион) %>% 
  summarise(tour_sum = sum(tourindex)) %>% 
  filter(tour_sum >= 5)
```

Выберем регионы, лидирующие по всем трем показателям:

```{r}
# Выберем из основного датафрейма регионы, лидирующие по всем трем показателями:
top <- dat[dat$Регион %in% top_tour$Регион, ]
unique(top$Регион)
```

Рассмотрим, в какие месяцы наблюдаются максимальные значения исследуемых нами показателей:

```{r, warning=FALSE, message=FALSE}
## Построим график, отображающий динамику значений исследуемых показателей по месяцам :
top_long <- top %>%
  select(1:6)

top_long <- pivot_longer(data = top_long, cols = 4:6, names_to = "Индекс", values_to = "Значение")

top_long %>% 
  ggplot(aes(x = Месяц, y = Значение, group = Индекс, color = Индекс)) +
  geom_line(size = 0.8) +
  geom_point(size = 1.2) +
  labs(title = "Динамика показателей СберИндекс наиболее перспективных регионов \n в 2020 году",
       x = "Месяц",
       y = "Значение") +
  scale_colour_manual(values = c("tomato", "steelblue", "palegreen3")) +
  facet_wrap(facets = ~`Регион`) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey98"))
```

Таким образом, наиболее наиболее перспективными для открытия филиалов банка являются следющие регионы (для каждого региона указан период, в котором наблюдались максимальные значения исследуемых показателей):

* Воронежская область
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: сентябрь
  + Количество внутренних туристов: январь - март, август - сентябрь
* Калининградская область
  + Доля безналичных платежей: май, ноябрь
  + Индекс потребительской активности: июнь - октябрь
  + Количество внутренних туристов: январь - февраль, июль - октябрь
* Камчатский край
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: февраль, июль - октябрь
  + Количество внутренних туристов: март, август - сентябрь, декабрь
* Кировская область
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: февраль, июнь - октябрь
  + Количество внутренних туристов: январь - март, август - сентябрь
* Нижегородская область
  + Доля безналичных платежей: май, ноябрь
  + Индекс потребительской активности: март, июль - октябрь
  + Количество внутренних туристов: январь - февраль, август - сентябрь
* Самарская область
  + Доля безналичных платежей: ноябрь
  + Индекс потребительской активности: март, июнь - ноябрь
  + Количество внутренних туристов: январь - март, август
  

```{r}
# График обобщенных показателей по всем выбранным регионам:
top %>% 
  group_by(Месяц) %>% 
  summarise(`Индекс потребительской активности` = mean(`Индекс потребительской активности`),
            `Доля безналичных платежей` = mean(`Доля безналичных платежей`),
            `Количество внутренних туристов` = mean(`Количество внутренних туристов`)) %>%
  pivot_longer(cols = 2:4, names_to = "Индекс", values_to = "Значение") %>% 
  ggplot(aes(x = Месяц, y = Значение, group = Индекс, color = Индекс)) +
  geom_line(size = 0.8) +
  geom_point(size = 1.2) +
  labs(title = "Динамика средних значений показателей СберИндекс \n выбранных регионов в 2020 году",
       x = "Месяц",
       y = "Значение") +
  scale_colour_manual(values = c("tomato", "steelblue", "palegreen3")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(color = "grey95"),
        panel.grid.minor = element_line(color = "grey98"))
```

Обобщая для всех регионов, месяцы, в которых показатели были максимальными:

* Доля безналичных платежей: май, ноябрь
* Индекс потребительской активности: февраль - март, июнь - октябрь
* Количество внутренних туристов: январь - март, сентябрь - октябрь

# Поиск взаимосвязей:

Проверим наличие связи между двумя показателями: Доля безналичных платежей и Количество внутренних туристов. Для этого построим график и вычислим коэффициент корреляции Пирсона.

```{r}
top %>% 
  ggplot(aes(x = `Доля безналичных платежей`, y = `Количество внутренних туристов`)) +
  geom_point(size = 3, shape = 21, color = "grey30", fill = "steelblue", alpha = 0.6) +
  labs(title = "Характер связи между двумя показателями") +
  theme_minimal()
```

На графики отсутствует заметная связь, между выбранными показателями.

```{r}
# Коэффициент корреляции Пирсона:
cor.test(top$`Доля безналичных платежей`, top$`Количество внутренних туристов`)
```

Значение p-value значительно превышает 0.05, поэтому на 5%-ном уровне значимости мы не можем отвергнуть нулевую гипотезу о независимости двух показателей. Другими словами, мы не можем говорить о наличии статистически значимой связи между долей безналичных платежей и количеством внутренних туристов.

Таким образом, мы не нашли оснований считать верным предположение о том, что в регионах, которые более активно
посещаются туристами, доля безналичных платежей выше.

Проверим наличие связи между общим количеством одобренных заявок на кредит и числом ипотечных сделок:

```{r}
cor.test(as.numeric(top$`Всего одобренных заявок`), as.numeric(top$`Всего ипотечных сделок`), method = "kendall")
```
Мы получили значение p-value меньшее 0.05 - мы можем отвергнуть нулевую гипотезу о равенстве нулю коэффициента корреляции между двумя исследуемыми показателями. Другими словами, на 5%-ном уровне значимости можно можно говорить о наличии сильной положительной связи между общим количеством одобренных заявок на кредит и числом ипотечных сделок.

```{r}
# Вычислим коэффициент корреляции Пирсона для доли безналичных платежей и  количеством заявок на кредиты онлайн:

cor.test(top$`Доля безналичных платежей`, top$`Доля онлайн-заявок`, method = "pearson")
```

При рассчете коэффициента корреляции Пирсона выявлена статистически-значимая положительная слабая связь на уровне значимости 5% (p-value < 0.05).

Таким образом, анализ взаимосвязей позволил сделать следующие выводы:

* Нет достаточных оснований говорить о наличии связи между количеством внутренних туристов в регионе и долей безналичиных платежей.
* Общее количество одобренных заявок на кредит сильно положительно коррелирует с общим числом ипотченых сделок.
* Между долей безналичных платежей и долей онлайн-заявок на кредит существует слабая статистически-значимая связь.

```{r}
# Введем новый столбец Сезон:
top <- top %>% 
  mutate(Сезон = as.factor(case_when(top$Месяц %in% c("Декабрь", "Январь", "Февраль") ~ "Зима",
                              top$Месяц %in% c("Март", "Апрель", "Май") ~ "Весна",
                              top$Месяц %in% c("Июнь", "Июль", "Август") ~
"Лето",
                              top$Месяц %in% c("Сентябрь", "Октябрь", "Ноябрь") ~ "Осень")), .after = `Квартал`)

```

```{r}
# Посторим график распределени ипотечных сделок по сезонам:
top %>% 
  ggplot(aes(x = `Сезон`, fill = `Всего ипотечных сделок`)) +
  geom_bar() +
  labs(title = "Распределение количества ипотечных сделок \n по сезонам",
       x = "Сезон",
       y = "Количество") +
  scale_fill_manual(values = c("palegreen3", "wheat", "lightpink", "steelblue")) +
  theme_minimal()
```


График показывает, что больше всего сделок ипотечных сделок жители исследуемых регионов совершают в осенние месяцы.

```{r, warning=FALSE}
# Боксплот доля онлайн-заявок на кредиты ~ сезон:
top %>% 
  ggplot(aes(x = `Сезон`, y = `Доля онлайн-заявок`, fill = Сезон)) +
  geom_boxplot() +
  labs(title = "Количество онлайн-заявок в разное время года",
       x = "Сезон",
       y = "Количество") +
  scale_fill_manual(values = c("lightpink", "steelblue", "palegreen3", "coral")) +
  stat_summary(fun.y = "mean", size = 0.3, shape = 21, color = "black", stroke = 0.5, alpha = 0.8) +
  theme_minimal()
```


```{r}
# Из боксплотов не очень понятно, особенно есть отдельно проставить средние значения, влияет ли существенно время год на количество онлайн-заявок. Нужно проверить, используя тсатистический критерий. Так как у нас есть факторная переменная Сезон, разбивающая наблюдения на четрые выборки, для сравнения средних получившихся выборок будем использовать критерий Краскела-Уоллиса:
kruskal.test(top$`Доля онлайн-заявок` ~ top$Сезон)
```
p-value > 0.05, поэтому мы не можем отвергнуть нулевую гипотезу о равенстве средних в каждой выборке и принять альтернативную гипотезу о том, что по крайней мере в одной выборке результаты отличаются. Таким образом, на 5%-ном уровне значимости у нас нет оснований считать, что доля ипотечных сделок на вторичное жильё зависит от времени года.

Проверим, различается ли доля заявок на вторичное жилья в разное время года:

```{r, warning=FALSE}
# Боксплот доля ипотечных сделок на вторичное жилье ~ сезон:
top %>% 
  ggplot(aes(x = `Сезон`, y = `Доля сделок, вторичка`, fill = Сезон)) +
  geom_boxplot(outlier.fill = "coral",
               outlier.shape = 21,
               outlier.size = 1.8) +
  labs(title = "Количество ипотечных сделок на вторичное жилье \n в разное время года",
       x = "Сезон",
       y = "Доля сделок - вторичка") +
  scale_fill_manual(values = c("lightpink", "steelblue", "palegreen3", "coral")) +
  stat_summary(fun.y = "mean", size = 0.3, shape = 21, color = "black", stroke = 0.5, alpha = 0.8) +
  theme_minimal()
```
График показывает, что доля сделок на вторичное жилье, соверешенных весной, летом и осенью, примерно одинаково. В то же время летом оно определенно ниже. Попробуем проверить формально с помощью статистического критерия. 

```{r}
# Так как критерий Краскела-Уоллиса применяется для тестирования гипотезы о равенстве средних, предварительно удалим нетипичные значения: 
sec_out <- top %>% 
  filter(Сезон == "Весна") %>% 
  select(`Доля сделок, вторичка`) %>% 
  pull()
iqr <- IQR(sec_out) 
q1 <- quantile(sec_out, 0.25)
q3 <- quantile(sec_out, 0.75)
lower_b <- q1 - 1.5 * iqr
upper_b <- q3 + 1.5 * iqr
sec_out[sec_out < lower_b | sec_out > upper_b]
# Есть одно нетипично низкое значение. Попробуем исключить его перед тестированием гипотезы
top_clean <- top %>% 
  filter(`Доля сделок, вторичка` != 0.46)
```

```{r}
# Оказалось, что удаленное значение совсем незначительно влияет на резльтат, В любом случае, p-value на порядок меньше 0.05:
kruskal.test(top$`Доля сделок, вторичка` ~ top$Сезон)
kruskal.test(top_clean$`Доля сделок, вторичка` ~ top_clean$Сезон)
```
Да, действительно, в случае ипотеки на вторичное жилье влияние времен года существенно: значение p-value < 0.05, поэтому мы можем отвергнуть нулевую гипотезу о равенстве средних значений в выборках и утверждать, что на уровне значимости 5% доля ипотченых сделок, совершенных по крайней мере в одном из сезонов, статистически отличается от остальных.


Обобщая вышесказанное, можно отметить, что количество ипотечных сделок неодинаково в разное время года. Больше всего сделок заключается в осенние месяцы. При этом не обнаружено статистически значимых различий между средними значениями количества онлайн-заявок на ипотеку в разное время года. В то же время имеет место влияние времени года на долю заявок на вторичное жилье  Полученные данные могут быть полезны, например, при планировании рекламы и акций ипотечных продуктов в разные месяцы.

## Построение регрессионных моделей:

Построение регрессионных моделей может помочь нам более детально понять влияние различных факторов на потребительскую активность и долю безналичных платежей, а также на предпочтение пользоваться онлайн-услугами банка и оформлять ипотеку. 

# Множественная линейная регрессия:

Построим линейную модель, описывающую зависимость потребительской активности от средней заработной платы в регионе, числа активных абонентов беспроводного наземного фиксированного доступа к сети Интернет и уровня безработицы населения.

```{r}
lmod <- lm(data = top, formula = `Индекс потребительской активности` ~ `Среднемесячная заработная плата` + `Число активных абонентов беспроводного доступа к сети` + `Уровень безработицы населения`)

summary(lmod)
```

```{r}
lmod2 <- lm(data = top, formula = `Доля безналичных платежей` ~ `Среднемесячная заработная плата` + `Число активных абонентов беспроводного доступа к сети` + `Уровень безработицы населения`)
summary(lmod2)
```


# Логистическая регрессия:

```{r}
# Добавим в датафрейм столбец, показыващие преобладание количества онлайн-заявок на кредит в офисе банка или онлайн, а также аналогичный столбец, где 1 соответсвует регионам с общим числом ипотечных сделок > 500:

top <- top %>% 
  mutate(is_online = ifelse(`Доля онлайн-заявок` > `Доля заявок в офисе банка`, 1, 0), .after = `Доля заявок в офисе банка`)

top$is_online <- as.factor(top$is_online)

top <- top %>% 
  mutate(hyp_love = ifelse(`Всего ипотечных сделок` %in% c("500 - 1 000", "> 1 000"), 1, 0), .after = `Всего ипотечных сделок`)

top$hyp_love <- as.factor(top$hyp_love)
```

Построрим первую регрессионную модель, которая зависимость склонности населения предпочитать онлайн-услуги банка от средней заработной платы в регионе, числа активных абонентов беспроводного наземного фиксированного доступа к сети Интернет и уровня безработицы населения.
```{r}
# Так как зависимая переменная у нас может принимать только два значения - 0 и 1, с которыми мы для удобства связали склонность выбирать онлайн услуги, будем использовать логистическую регрессионную модель:
logmod <- glm(data = top,
              formula = top$is_online ~ `Среднемесячная заработная плата` + `Число активных абонентов беспроводного доступа к сети` + `Уровень безработицы населения` + `Сезон`, family = "binomial")

summary(logmod)

exp(coef(logmod))
```

Выдача R показывает, что статистически значимым на уровне 5% оказался только коэффициент при одном факторе - среднемесячной заработной плате. Однако, его влияние незначительно (при увеличении средней зарплаты на 1 рубль вероятность склонности выбирать онлайн-услуги увеличивается в среднем в 1.000087 раз при прочих равных). Чтобы было более показательно, попробуем изменить столбец Средняя заработная плата таким образом, чтобы значения отображались в тысячах рублей.

```{r}
top <- top %>% 
  mutate(`Средняя заработная плата тысячи` = `Среднемесячная заработная плата` / 1000, .after = `Среднемесячная заработная плата`)
```

```{r}
# Продублируем модель с новой размерностью и посмотрим, как это повлияет на коэффициенты при показателях:
logmod1000 <- glm(data = top,
              formula = top$is_online ~ `Средняя заработная плата тысячи` + `Число активных абонентов беспроводного доступа к сети` + `Уровень безработицы населения` + `Сезон`, family = "binomial")

summary(logmod1000)
exp(coef(logmod1000))
```

Мы получили вполне ожидаемый результат: статистически значимым остался только коэффициент при показателе среднемесячной заработной плтаты, при этом сам коэффициент немного поменялся, а его интерпретация стала более наглядной: при увеличении средней заработной платы на 1 тысячу рублей веротятность того, что потребитель предпочтет оформлять заявку на кредит онлайн возрастает в среднем в 1.09 раз при прочих равных условиях.

Построим вторую модель, которая позволит охарактеризовать влияние того же набора показателей на склонность населения оформлять ипотеку.

```{r}
logmod2 <- glm(data = top, 
               formula = hyp_love ~ `Средняя заработная плата тысячи` +
                 `Число активных абонентов беспроводного доступа к сети` +
                 `Уровень безработицы населения` +
                 `Сезон`, family = "binomial")

summary(logmod2)
exp(coef(logmod2))
```
Выдача R показывает, что статистически значимыми на уровне 5% являются показатели Средняя заработная плата и Число активных абонентов беспроводного доступа к сети. При увеличении средней заработной платы на 1 тысячу рублей склонность потребителя оформлять ипотеку увеличивается в 0.93 раза (или уменьшается на 7%), при условии, что значения других показателей не изменяются. Число активных абонентов беспроводного интернета положительно связано с зависимой переменной: при увеличении первого на 1 склонность оформлять ипотеку увеличивается в 1.0008 раз (или ~ в 1.08 раз при увеличении на 100).

# Оценка качества полученных моделей:

Так как полученные нами модели являются логистическими (зависимая переменная может принимать значение 0 либо 1), оценим, насколько точно каждая модель предсказывает положительный и отрицательный исходы. Для этого сравним полученные на предыдущем этапе значения столбцов is_online и hyp_love с предсказанными значениями для каждой модели.

```{r}
## Вычислим чувствительность и специфичность для первой модели:
top <- top %>% 
  mutate(is_online_predicted = ifelse(logmod$fitted.values > mean(logmod$fitted.values), 1, 0), .after = is_online)

# Верно предсказанные 0 (True Negative):
TN <- top %>% 
  filter(is_online == 0, is_online_predicted == 0) %>% 
  nrow()
# Ложно предсказанные 1 (False Positive):
FP <- top %>% 
  filter(is_online == 0, is_online_predicted == 1) %>% 
  nrow()
# Ложно предсказанные 0 (False Negative):
FN <- top %>% 
  filter(is_online == 1, is_online_predicted == 0) %>% 
  nrow()
# Верно предсказанные 1 (True Positive):
TP <- top %>% 
  filter(is_online == 1, is_online_predicted == 1) %>% 
  nrow()

# Специфичность модели:
specif <- TN / (TN + FP)

# Чувствительность:
sens <- TP / (TP + FN)

# Чувствительность и специфичность полученной модели = 0.785 и 0.793. Другими словами наша модель нашла 78.5% из всех истинно положительных исходов. Также в 79.3% случаев, модель правильно предсказала 0 среди общего числа истинно отрицательных исходов.
```

Построим ROC-кривую, еще один инструмент, который поможет наглядно отобразить качество исследуемой нами модели.

```{r}
proc <- roc(top$is_online ~ logmod$fitted.values)
proc
plot(proc)
text(x = 1, y = 0.9, "AUC = 0.88")
```

Площадь под ROC-кривой (AUC) модет принимать значения от 0 до 1. Высокие значения AUC, близкие к 1, соотвествуют высокому качеству регрессионной модели. В нашем случае AUC = 0.88, в связи с чем можно говорить о достаточно высокой предсказательной силе модели.

Повторим то же самое для второй модели.

```{r}
## Вычислим чувствительность и специфичность для второй модели:
top <- top %>% 
  mutate(hyp_love_predicted = ifelse(logmod2$fitted.values > mean(logmod2$fitted.values), 1, 0), .after = hyp_love)

# Верно предсказанные 0 (True Negative):
TN2 <- top %>% 
  filter(hyp_love == 0, hyp_love_predicted == 0) %>% 
  nrow()
# Ложно предсказанные 1 (False Positive):
FP2 <- top %>% 
  filter(hyp_love == 0, hyp_love_predicted == 1) %>% 
  nrow()
# Ложно предсказанные 0 (False Negative):
FN2 <- top %>% 
  filter(hyp_love == 1, hyp_love_predicted == 0) %>% 
  nrow()
# Верно предсказанные 1 (True Positive):
TP2 <- top %>% 
  filter(hyp_love == 1, hyp_love_predicted == 1) %>% 
  nrow()

# Специфичность модели:
specif2 <- TN2 / (TN2 + FP2)

# Чувствительность:
sens2 <- TP2 / (TP2 + FN2)

# Чувствительность и специфичность второй модели logmod2 оказались еще выше = 0.84 и 0.82 соответственно. Интерпретировать эти значения можно следующим образом: в 84% случаев модель правильно угадывает 1 и в 82% случаев правильно предсказывает 0.
```

ROC-кривая и AUC:

```{r}
proc2 <- roc(top$hyp_love ~ logmod2$fitted.values)
proc2
plot(proc2)
text(x = 1.05, y = 0.9, "AUC = 0.91")
```
Значение AUC = 0.91, получилось еще выше, чем у предыдущей модели.

Таким образом, мы провели оценку качества для двух логистических регрессионных моделей двумя способами: рассчитав чувствительность и специфичность, а также значение AUC для ROC-кривой.

Для модели, предсказывающей склонность населения предпочитать онлайн-услуги банка:

* Чувствительность = 0.785 
* Специфичность = 0.793
* AUC = 0.88

Модель, предсказывающая склонность населения оформлять ипотеку:

* Чувствительность = 0.84 
* Специфичность = 0.82
* AUC = 0.91

Вторая модель характеризуется более высокими показателями.

Обобщая полученные результаты, можно сделать вывод о том, что обе модели имеют достаточно хорошую предсказательную мощность.




